---
title: "Market Basket Analysis"
output: html_document
---

## R Markdown

Loading the required libraries 

```{r setup,warning = FALSE, message = FALSE}
library(arules)
library(arulesViz)
```


Let us begin. Loading the data set. Here we are not loading using read.csv() function. Why? If you take a look into the data set out data set does not have variables in it. So this might create problem when we load. The read.transactions() function changes the dataset into a sparse matrix. It makes each row represent a transaction and creates columns for each item that a customer might purchase. Electronidex sells 125 items, so the sparse matrix creates 125 columns. It also changes the data to binary. (1=item purchased in that transaction OR 0=no purchase.)

```{r warning=FALSE}
TransactionDataSet <-suppressMessages( read.transactions("ElectronidexTransactions2017.csv",format = c( "basket"),header = FALSE, sep = ",",cols = NULL, rm.duplicates = FALSE, quote = "\"'", skip = 0,encoding = "unknown"))

summary(TransactionDataSet)

```

To view data set as a whole use "inspect (DatasetName)". This is gonna take a lot of time. 

```{r}
inspect (TransactionDataSet[1:5])
LIST(TransactionDataSet[1:5])#Lists the transactions by conversion (LIST must be capitalized)
length(TransactionDataSet) # length of transaction
size(TransactionDataSet[1:10]) #No:of items per transaction upto the 10th row

length(itemLabels(TransactionDataSet))# To see the length of item labels.. or lets say the list od label
```
There is total of 125 items & our data set has 9835 transactions

```{r}
itemFrequencyPlot(TransactionDataSet, topN =10, col = rainbow(4),type = "relative")

```

```{r eval=FALSE, include=FALSE}
itemFrequency(TransactionDataSet[, 1:3]) #to view the support level for the first three items in the TransactionDataSet data: 
itemmost <- itemFrequency(TransactionDataSet)
head(itemmost)
```

Let us find the list of items which are less popular.The below shows the list of 6 items with less sales volume:
```{r echo=FALSE, warning=FALSE}
itemLeast_relative <- sort(itemFrequency(TransactionDataSet), decreasing = FALSE)
itemLeast_absolue <- sort(itemFrequency(TransactionDataSet, type = "absolute"), decreasing = FALSE)
itemLeast_relative[1:6]
```
```{r eval=FALSE, include=FALSE}
#No:of items with frequency more than 0.1.

itemLeastlist <- unname(itemLeast_relative) > 0.1
index = which(itemLeastlist %in% "TRUE")
itemLeast_relative[index]
length(index)
```


In addition to looking at the items, it’s also possible to visualize the entire sparse matrix. To do so, use the image() function. The command to display the sparse matrix for the first 10 transactions is as follows:
```{r}
image(TransactionDataSet[1:10],
      xlab = "Items (Columns)", 
    ylab = "Transactions (Rows)")
```

this visualization will not be as useful for extremely large transaction databases, because the cells will be too small to discern. Still, by combining it with the sample() function, you can view the sparse matrix for a randomly sampled set of transactions. The command to create random selection of 100 transactions is as follows:
```{r}
image(sample(TransactionDataSet,100))
```

From the graph we can understand that there is some popular items in the store as few columns seem fairly heavily populated.But overall, the distribution of dots seems fairly random.

## Apiorifunction
```{r}
rules1 <- apriori(TransactionDataSet,parameter = list(supp = 0.005, conf =0.6,minlen = 1,maxlen=10,target = "rules"))
rules1
rules1 <- sort(rules1, by = 'lift')
```

These parameters are requesting that the rules cover 10% of the transactions and are 80% correct.

To View the rule

```{r}
inspect(rules1[1:5])
#str(rules_df)
```

Receiving 0 rules means that you will need to experiment with the Support and Confidence values. 

Now we recieved : set of 28 rules 

When you're experimenting keep in mind:

1. If these values are too high, you will receive no rules or non-helpful rules.
2. If these values are too low, your computational time/memory will suffer, or you'll receive too many rules. 
3. To get ‘strong' rules, increase the value of ‘conf’ parameter.

Evalauting & taking a deep look
```{r}
summary(rules1)
```
The summary of the rules gives us some very interesting information:
1. The number of rules: 28.
2. The distribution of rules by length: a length of 3 items has the most rules.
3. The summary of quality measures: ranges of support, confidence, and lift.
4. The information on data mining: total data mined, and the minimum parameters we set earlier.

Removing the redundant

```{r}
table(is.redundant(rules1))

```
```{r eval=FALSE, include=FALSE}
#to remove redundant 
subset.matrix <- is.subset(rules1,rules1)
subset.matrix[lower.tri(subset.matrix, diag = T)] <- NA
redundant <- colSums(subset.matrix, na.rm =T) >= 1
which(redundant)
#rules1test.pruned <- rules1[!redundant]
#rules1 <- rules1test.pruned
```

Ploting the 10 rules
```{r}
topRules <- rules1[1:5]
plot(rules1)
```

plot(rules1[1:3], method = "graph", control = list(type= "items"))

```{r, echo=FALSE,results='hide',fig.keep='all'}
invisible(plot(rules1[1:3], method = "graph", control = list(type= "items")))
```
```{r}
plot(rules1, method="paracoord", control=list(reorder=TRUE))
```
```{r}
plot(topRules, method = "grouped")
```
```{r}
#plot(rules1,method="graph",engine='interactive' ,shading=NA)
```
The interactive mode performs better but can not be displayed in knit mode.

```{r}
ItemRules <- subset(rules1, items %in% "HP Laptop")
inspect(ItemRules[1:5])
```


```{r}
rules_df <- as(rules1, "data.frame")
str(rules_df)
write(rules1, file = "rules_df.csv", sep = ",", quote = TRUE, row.names = FALSE)
```

Now we know Laptop & Imax...
lets understand if we can use them to purchase lower frequency products 
```{r}
rules_highest_lhs <- apriori(data= TransactionDataSet, parameter = list(supp = 0.01, conf=0.2),appearance = list(default = "rhs", lhs = "iMac"))
rules_highest_lhs
rules_highest_lhs <- sort(rules_highest_lhs, by ="lift")
inspect(rules_highest_lhs)
plot(rules_highest_lhs, method="paracoord", control=list(reorder=TRUE))
```
```{r}
rules_highest_lhs <- apriori(data= TransactionDataSet, parameter = list(supp = 0.03, conf=0.2),appearance = list(default = "rhs", lhs = "HP Laptop"))
rules_highest_lhs
rules_highest_lhs <- sort(rules_highest_lhs, by ="lift")
inspect(rules_highest_lhs)
plot(rules_highest_lhs, method="paracoord", control=list(reorder=TRUE))
```


```{r eval=FALSE, include=FALSE}
rules_highest_lhs <- apriori(data= TransactionDataSet, parameter = list(supp = 0.03, conf=0.2),appearance = list(default = "rhs", lhs = "Dell Wired Keyboard"))
rules_highest_lhs
rules_highest_lhs <- sort(rules_highest_lhs, by ="lift")
inspect(rules_highest_lhs)
```
